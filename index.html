<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LotoFácil Analyst AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (Excel Support) - CORRIGIDO PARA CDNJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- jsPDF & AutoTable (PDF Generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hidden-section { display: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Hide Scrollbar for clean mobile horizontal scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #9333ea;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltip Styles - Adjusted for Z-Index Priority */
        .tooltip-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 4px;
            z-index: 50; 
            cursor: pointer;
        }
        
        /* CRITICAL FIX: Elevate wrapper z-index on hover to sit on top of everything else */
        .tooltip-wrapper:hover,
        .tooltip-wrapper:active,
        .tooltip-wrapper:focus-within {
            z-index: 10000;
        }
        
        .tooltip-icon {
            color: #94a3b8;
            cursor: help;
            transition: color 0.2s;
        }
        
        .tooltip-wrapper:hover .tooltip-icon {
            color: #a855f7; /* Purple-500 */
        }

        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            width: 240px;
            background-color: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(4px);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.7rem;
            font-weight: normal;
            line-height: 1.4;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            border: 1px solid #334155;
            z-index: 10001; 
        }

        .tooltip-wrapper:hover .tooltip-content,
        .tooltip-wrapper:active .tooltip-content,
        .tooltip-wrapper:focus-within .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(15, 23, 42, 0.98) transparent transparent transparent;
        }

        /* Heatmap Cell Animation */
        .heatmap-cell {
            transition: all 0.3s ease;
        }
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #9333ea;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #9333ea;
        }
        .toggle-checkbox:checked + .toggle-label + .dot {
            transform: translateX(100%);
        }
        
        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .accordion-content.active {
            max-height: 1000px;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- Notifications -->
    <div id="notification-container" class="fixed top-4 left-4 right-4 z-[10000] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Modal Probabilidades -->
    <div id="prob-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[9000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-in fade-in zoom-in duration-200">
            <div class="bg-blue-600 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-md">
                <div class="flex items-center gap-2">
                    <i data-lucide="calculator" class="w-5 h-5"></i>
                    <h3 class="font-bold text-base">Probabilidades Reais (15 nºs)</h3>
                </div>
                <button onclick="closeProbModal()" class="hover:text-blue-200 p-1"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-4 py-2 rounded-l-lg">Acertos</th>
                            <th class="px-4 py-2 rounded-r-lg text-right">Probabilidade (1 em...)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr class="hover:bg-slate-50"><td class="px-4 py-3 font-bold text-green-600">15 Números</td><td class="px-4 py-3 text-right font-mono">3.268.760</td></tr>
                        <tr class="hover:bg-slate-50"><td class="px-4 py-3 font-semibold text-blue-600">14 Números</td><td class="px-4 py-3 text-right font-mono">21.791</td></tr>
                        <tr class="hover:bg-slate-50"><td class="px-4 py-3">13 Números</td><td class="px-4 py-3 text-right font-mono">691</td></tr>
                        <tr class="hover:bg-slate-50"><td class="px-4 py-3">12 Números</td><td class="px-4 py-3 text-right font-mono">59</td></tr>
                        <tr class="hover:bg-slate-50"><td class="px-4 py-3">11 Números</td><td class="px-4 py-3 text-right font-mono">11</td></tr>
                    </tbody>
                </table>
                <p class="text-[10px] text-slate-400 mt-4 text-center">Fonte: Caixa Econômica Federal (Aposta Simples)</p>
            </div>
        </div>
    </div>

    <!-- Modal Último Jogo -->
    <div id="last-game-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[9000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-in fade-in zoom-in duration-200">
            <div class="bg-emerald-600 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-md">
                <div class="flex items-center gap-2">
                    <i data-lucide="globe" class="w-5 h-5"></i>
                    <h3 class="font-bold text-base">Último Resultado Oficial</h3>
                </div>
                <button onclick="closeLastGameModal()" class="hover:text-emerald-200 p-1"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 text-center">
                <div class="mb-4">
                    <p class="text-sm text-slate-500 uppercase tracking-wider">Concurso</p>
                    <p class="text-3xl font-bold text-slate-800" id="lg-concurso">--</p>
                    <p class="text-xs text-slate-400" id="lg-data">--/--/----</p>
                </div>
                
                <div class="flex flex-wrap justify-center gap-2 mb-4" id="lg-dezenas">
                    <!-- Bolas aqui -->
                </div>
                
                <p class="text-[10px] text-slate-400 mt-4 border-t pt-2">Dados da API carregados e adicionados à lista de exclusão.</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-purple-900 text-white shadow-lg sticky top-0 z-40 transition-all">
        <div class="max-w-6xl mx-auto p-4 md:p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="bg-white p-2 rounded-full shadow-inner text-purple-700 flex-shrink-0">
                        <i data-lucide="zap" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </div>
                    <div class="flex-1">
                        <h1 class="text-xl md:text-2xl font-bold tracking-tight leading-tight">LotoFácil Analyst AI</h1>
                        <p class="text-purple-200 text-xs md:text-sm">Sistema de Análise Preditiva</p>
                    </div>
                </div>
                
                <nav class="flex gap-2 bg-purple-800 p-1 rounded-xl shadow-inner w-full md:w-auto overflow-x-auto no-scrollbar">
                    <button onclick="switchView('dashboard')" id="nav-dashboard" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded-lg transition-all text-xs md:text-sm font-bold bg-white text-purple-900 shadow-md whitespace-nowrap">
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard
                    </button>
                    <button onclick="switchView('generator')" id="nav-generator" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded-lg transition-all text-xs md:text-sm text-purple-200 hover:bg-purple-700 whitespace-nowrap">
                        <i data-lucide="zap" class="w-4 h-4"></i> Gerador
                    </button>
                    <button onclick="switchView('saved')" id="nav-saved" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-3 py-2 rounded-lg transition-all text-xs md:text-sm text-purple-200 hover:bg-purple-700 relative whitespace-nowrap">
                        <i data-lucide="list" class="w-4 h-4"></i> Jogos
                        <span id="saved-badge" class="hidden absolute top-1 right-1 md:-top-1 md:-right-1 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full border-2 border-purple-900 shadow-sm">0</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-3 md:p-6 space-y-4 md:space-y-6 flex-grow w-full">

        <!-- Upload Section -->
        <section id="upload-section" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-10 text-center mt-4 md:mt-10 max-w-2xl mx-auto animate-fade-in">
            <div class="w-16 h-16 md:w-20 md:h-20 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 md:mb-6 shadow-sm">
                <i data-lucide="upload" class="w-8 h-8 md:w-10 md:h-10"></i>
            </div>
            <h2 class="text-xl md:text-2xl font-bold mb-2 text-slate-800">Importar Base de Dados</h2>
            <p class="text-sm md:text-base text-slate-500 mb-6 max-w-md mx-auto leading-relaxed">
                Carregue o CSV ou Excel oficial para iniciar a IA. O arquivo será salvo no seu navegador.
            </p>
            
            <label id="upload-label" class="cursor-pointer w-full md:w-auto inline-flex items-center justify-center gap-3 bg-purple-600 hover:bg-purple-700 text-white px-6 py-4 rounded-xl font-bold text-base md:text-lg transition-all active:scale-95 shadow-lg shadow-purple-200 touch-manipulation">
                <input type="file" accept=".csv, .xlsx, .xls" onchange="handleFileUpload(this)" class="hidden" />
                <i data-lucide="file-text" class="w-5 h-5 md:w-6 md:h-6"></i>
                <span id="upload-text">Selecionar Arquivo</span>
            </label>
            <p id="upload-error" class="hidden mt-6 text-red-500 flex items-center justify-center gap-2 bg-red-50 p-4 rounded-lg border border-red-100 text-sm"></p>
        </section>

        <!-- Loading State (Global) -->
        <div id="global-loader" class="hidden text-center py-20">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-purple-600 font-medium animate-pulse text-sm">Processando dados...</p>
        </div>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="hidden-section space-y-4 md:space-y-6">
            <div class="flex justify-end gap-2 flex-wrap">
                <button onclick="obterLotofacil()" class="text-xs text-slate-400 hover:text-emerald-600 flex items-center gap-1 transition-colors p-2 border border-transparent hover:border-emerald-200 rounded-lg">
                    <i data-lucide="globe" class="w-3 h-3"></i> Último Jogo
                </button>
                <button onclick="openProbModal()" class="text-xs text-slate-400 hover:text-blue-500 flex items-center gap-1 transition-colors p-2 border border-transparent hover:border-blue-200 rounded-lg">
                    <i data-lucide="calculator" class="w-3 h-3"></i> Probabilidades
                </button>
                <button onclick="clearDatabase()" class="text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors p-2 border border-transparent hover:border-red-200 rounded-lg">
                    <i data-lucide="database" class="w-3 h-3"></i> Limpar Dados
                </button>
            </div>

            <!-- Stats Header -->
            <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-xl p-5 md:p-6 text-white shadow-lg relative">
                <div class="absolute inset-0 overflow-hidden rounded-xl pointer-events-none z-0">
                    <div class="absolute top-0 right-0 p-4 opacity-5">
                       <i data-lucide="sigma" class="w-32 h-32"></i>
                    </div>
                </div>
                
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4 opacity-90">
                        <i data-lucide="sigma" class="w-5 h-5 text-purple-400"></i>
                        <h3 class="text-xs md:text-sm font-bold uppercase tracking-wider">Estatísticas Avançadas (Soma)</h3>
                        <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                            <i data-lucide="circle-help" class="tooltip-icon w-4 h-4 text-purple-400"></i>
                            <div class="tooltip-content">
                                Dados calculados somando as 15 dezenas de cada jogo histórico.
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8">
                        <div class="bg-slate-800/50 p-2 rounded-lg md:bg-transparent md:p-0">
                            <div class="flex items-center gap-1 text-[10px] md:text-xs text-slate-400 uppercase mb-1">
                                Média
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3"></i>
                                    <div class="tooltip-content">Valor médio da soma de todos os sorteios passados.</div>
                                </div>
                            </div>
                            <div class="text-xl md:text-3xl font-bold" id="stat-avg">0</div>
                        </div>
                        <div class="bg-slate-800/50 p-2 rounded-lg md:bg-transparent md:p-0">
                            <div class="flex items-center gap-1 text-[10px] md:text-xs text-slate-400 uppercase mb-1">
                                Mediana
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3"></i>
                                    <div class="tooltip-content">Valor central exato.</div>
                                </div>
                            </div>
                            <div class="text-xl md:text-3xl font-bold text-blue-400" id="stat-median">0</div>
                        </div>
                        <div class="bg-slate-800/50 p-2 rounded-lg md:bg-transparent md:p-0">
                            <div class="flex items-center gap-1 text-[10px] md:text-xs text-slate-400 uppercase mb-1">
                                Moda
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3"></i>
                                    <div class="tooltip-content">A soma mais frequente.</div>
                                </div>
                            </div>
                            <div class="text-xl md:text-3xl font-bold text-green-400" id="stat-mode">0</div>
                        </div>
                        <div class="bg-slate-800/50 p-2 rounded-lg md:bg-transparent md:p-0">
                             <div class="flex items-center gap-1 text-[10px] md:text-xs text-slate-400 uppercase mb-1">
                                Desvio Pad.
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3"></i>
                                    <div class="tooltip-content">Mede a volatilidade.</div>
                                </div>
                             </div>
                            <div class="text-xl md:text-3xl font-bold text-purple-400" id="stat-stdDev">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Cards Grid (Optimized for Mobile) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                <!-- Concursos -->
                <div class="bg-white p-3 md:p-5 rounded-xl border border-slate-200 shadow-sm relative group hover:border-purple-300 transition-colors">
                    <div class="absolute inset-0 overflow-hidden rounded-xl z-0 pointer-events-none">
                        <div class="absolute right-0 bottom-0 w-16 h-16 md:w-24 md:h-24 bg-purple-50 rounded-full -mr-6 -mb-6 md:-mr-8 md:-mb-8"></div>
                    </div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1 md:mb-2">
                            <span class="text-slate-500 text-xs md:text-sm font-medium flex items-center">
                                Concursos
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3 md:w-3.5 md:h-3.5"></i>
                                    <div class="tooltip-content">Total de sorteios históricos.</div>
                                </div>
                            </span>
                            <i data-lucide="file-text" class="text-purple-500 w-4 h-4 md:w-5 md:h-5"></i>
                        </div>
                        <div class="text-xl md:text-3xl font-bold text-slate-800" id="kpi-total">0</div>
                    </div>
                </div>

                <!-- Jogos Excluídos -->
                <div class="bg-white p-3 md:p-5 rounded-xl border border-slate-200 shadow-sm relative group hover:border-orange-300 transition-colors">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1 md:mb-2">
                            <span class="text-slate-500 text-xs md:text-sm font-medium flex items-center">
                                Exclusões
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3 md:w-3.5 md:h-3.5"></i>
                                    <div class="tooltip-content">Total de combinações bloqueadas.</div>
                                </div>
                            </span>
                            <i data-lucide="shield-alert" class="text-orange-500 w-4 h-4 md:w-5 md:h-5"></i>
                        </div>
                        <div class="text-xl md:text-3xl font-bold text-slate-800" id="kpi-excluded">0</div>
                        <div class="text-[10px] md:text-xs text-orange-600 mt-0.5 font-semibold truncate" id="kpi-excluded-sub">+0 salvos</div>
                    </div>
                </div>

                <!-- Hot Number -->
                <div class="bg-white p-3 md:p-5 rounded-xl border border-slate-200 shadow-sm relative">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1 md:mb-2">
                            <span class="text-slate-500 text-xs md:text-sm font-medium flex items-center">
                                + Quente
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3 md:w-3.5 md:h-3.5"></i>
                                    <div class="tooltip-content">O número mais sorteado.</div>
                                </div>
                            </span>
                            <i data-lucide="trending-up" class="text-green-500 w-4 h-4 md:w-5 md:h-5"></i>
                        </div>
                        <div class="flex items-baseline gap-1 md:gap-2">
                            <div class="text-xl md:text-3xl font-bold text-slate-800" id="kpi-hot-num">0</div>
                            <span class="text-[10px] md:text-xs text-green-600 font-medium" id="kpi-hot-pct">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Cold Number -->
                <div class="bg-white p-3 md:p-5 rounded-xl border border-slate-200 shadow-sm relative">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1 md:mb-2">
                            <span class="text-slate-500 text-xs md:text-sm font-medium flex items-center">
                                + Fria
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-3 h-3 md:w-3.5 md:h-3.5"></i>
                                    <div class="tooltip-content">O número menos sorteado.</div>
                                </div>
                            </span>
                            <i data-lucide="trending-up" class="text-red-500 w-4 h-4 md:w-5 md:h-5 transform rotate-180"></i>
                        </div>
                        <div class="flex items-baseline gap-1 md:gap-2">
                            <div class="text-xl md:text-3xl font-bold text-slate-800" id="kpi-cold-num">0</div>
                            <span class="text-[10px] md:text-xs text-red-600 font-medium" id="kpi-cold-pct">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 class="text-base md:text-lg font-semibold mb-4 text-slate-800 flex items-center gap-2">
                        <i data-lucide="grid-3x3" class="w-4 h-4 md:w-5 md:h-5 text-slate-400"></i> Mapa de Calor (Frequência)
                        <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                            <i data-lucide="circle-help" class="tooltip-icon w-4 h-4"></i>
                            <div class="tooltip-content">Visualização das dezenas mais quentes (Verde) e frias (Azul) no formato do volante. Clique para ver atraso.</div>
                        </div>
                    </h3>
                    <div id="freq-heatmap" class="grid grid-cols-5 gap-2 md:gap-3 aspect-square max-w-sm mx-auto w-full p-2">
                        <!-- Heatmap cells injected here -->
                    </div>
                    <div class="flex justify-between text-[10px] md:text-xs text-slate-400 px-4 mt-2 max-w-sm mx-auto w-full">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Frio</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-slate-300"></div> Médio</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> Quente</span>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-base md:text-lg font-semibold mb-4 text-slate-800 flex items-center gap-2">
                        Tendência da Soma (Últimos 20)
                        <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                            <i data-lucide="circle-help" class="tooltip-icon w-4 h-4"></i>
                            <div class="tooltip-content">Variação da soma das dezenas nos últimos 20 concursos. Linha pontilhada = Média (195).</div>
                        </div>
                    </h3>
                    <div class="h-56 md:h-64 w-full relative">
                        <canvas id="sumTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Generator Section -->
        <section id="generator-section" class="hidden-section max-w-2xl mx-auto space-y-6 md:space-y-8 animate-fade-in">
            <div class="text-center space-y-2">
                <h2 class="text-2xl md:text-3xl font-bold text-slate-800">Gerador Inteligente</h2>
                <p class="text-sm md:text-base text-slate-500">Universo de exclusão: <strong class="text-purple-600" id="gen-exclusion-count">0</strong> combinações</p>
                
                <!-- Repeat Toggle -->
                <div class="flex items-center justify-center mt-4 mb-2">
                    <label for="repeat-toggle" class="flex items-center cursor-pointer relative">
                        <div class="relative">
                            <input type="checkbox" id="repeat-toggle" class="sr-only toggle-checkbox">
                            <div class="w-10 h-6 bg-gray-300 rounded-full shadow-inner transition-colors toggle-label"></div>
                            <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition-transform"></div>
                        </div>
                        <div class="ml-3 text-sm text-slate-600 font-medium">
                            Basear no último sorteio? <span class="text-xs text-slate-400">(8-10 repetidas)</span>
                        </div>
                    </label>
                </div>
                <style>
                    /* Custom Toggle Styles */
                    .toggle-checkbox:checked + .toggle-label { background-color: #9333ea; }
                    .toggle-checkbox:checked + .toggle-label + .dot { transform: translateX(100%); }
                </style>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-purple-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-purple-500 via-pink-500 to-indigo-500"></div>
                
                <!-- Numbers Display -->
                <div id="generator-display" class="flex justify-center mb-8 min-h-[4rem] flex-wrap gap-2 md:gap-3">
                    <div class="flex flex-col items-center justify-center text-slate-300 h-32 border-2 border-dashed border-slate-100 rounded-xl w-full bg-slate-50/50">
                        <i data-lucide="play-circle" class="w-10 h-10 md:w-12 md:h-12 mb-2 opacity-20"></i>
                        <span class="italic font-medium text-sm md:text-base">Gere um novo jogo</span>
                    </div>
                </div>

                <!-- Action Buttons (Save) - Hidden initially -->
                <div id="save-area" class="hidden flex-col gap-4 mb-6">
                    <div class="flex justify-between text-xs md:text-sm text-slate-600 bg-slate-50 p-3 md:p-4 rounded-xl border border-slate-100 shadow-inner">
                        <div class="text-center flex-1">
                            <span class="block text-[10px] md:text-xs text-slate-400 uppercase">Soma</span>
                            <span class="font-bold text-base md:text-lg" id="gen-sum">0</span>
                        </div>
                        <div class="text-center border-l border-slate-200 pl-2 flex-1">
                            <span class="block text-[10px] md:text-xs text-slate-400 uppercase">Pares</span>
                            <span class="font-bold text-base md:text-lg" id="gen-even">0</span>
                        </div>
                        <div class="text-center border-l border-slate-200 pl-2 flex-1">
                            <span class="block text-[10px] md:text-xs text-slate-400 uppercase">Ímpares</span>
                            <span class="font-bold text-base md:text-lg" id="gen-odd">0</span>
                        </div>
                    </div>
                    <button onclick="saveCurrentGame()" class="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-base md:text-lg shadow-lg shadow-green-200 transition-all active:scale-95 touch-manipulation">
                        <i data-lucide="save" class="w-5 h-5 md:w-6 md:h-6"></i> SALVAR JOGO
                    </button>
                </div>

                <!-- Generate Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                    <button onclick="generateGame('smart')" class="flex flex-col items-center justify-center p-4 md:p-5 bg-gradient-to-br from-purple-700 to-indigo-800 text-white rounded-xl hover:from-purple-800 hover:to-indigo-900 transition-all active:scale-95 shadow-lg group relative overflow-hidden touch-manipulation">
                        <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="zap" class="w-8 h-8 md:w-10 md:h-10"></i></div>
                        <div class="flex items-center gap-2 mb-1 relative z-10">
                            <span class="font-bold text-lg md:text-xl">IA Estatística</span>
                        </div>
                        <span class="text-[10px] md:text-xs opacity-80 text-purple-200 relative z-10">Filtros Inteligentes</span>
                    </button>

                    <button onclick="generateGame('random')" class="flex flex-col items-center justify-center p-4 md:p-5 bg-white border-2 border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 hover:border-slate-300 transition-all active:scale-95 group touch-manipulation">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-lg md:text-xl">Surpresinha</span>
                        </div>
                        <span class="text-[10px] md:text-xs opacity-60">Garante unicidade</span>
                    </button>
                </div>
            </div>
            
            <!-- INVESTMENT SIMULATOR -->
            <section class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 mt-6">
                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="calculator" class="text-blue-600 w-5 h-5"></i>
                    Simulação de Investimento
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                                Valor da Aposta (15 nºs):
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-4 h-4 text-purple-400"></i>
                                    <div class="tooltip-content">Valor base cobrado pela lotérica para uma aposta simples de 15 números.</div>
                                </div>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">R$</span>
                                <input type="number" id="base-price" value="3.00" step="0.50" onchange="calculateMultiple()" class="w-full p-3 pl-8 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none text-slate-800 font-medium">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-2">Quantidade de dezenas:</label>
                            <select id="multiple-select" onchange="calculateMultiple()" class="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white text-slate-800">
                                <option value="15">15 Dezenas (Aposta Simples)</option>
                                <option value="16">16 Dezenas (16 Apostas)</option>
                                <option value="17">17 Dezenas (136 Apostas)</option>
                                <option value="18">18 Dezenas (816 Apostas)</option>
                                <option value="19">19 Dezenas (3.876 Apostas)</option>
                                <option value="20">20 Dezenas (15.504 Apostas)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 flex flex-col justify-center">
                        <div class="flex justify-between mb-3 border-b border-blue-200 pb-2">
                            <span class="text-sm text-blue-700">Custo Total:</span>
                            <span id="calc-price" class="font-bold text-xl text-blue-900">R$ 3,00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-blue-700">Probabilidade (15pts):</span>
                            <span id="calc-prob" class="font-bold text-sm text-blue-900 text-right">1 em 3.268.760</span>
                        </div>
                        <p class="text-[10px] text-blue-400 mt-3 text-center italic" id="calc-eq">Equivale a 1 aposta simples</p>
                    </div>
                </div>
            </section>

            <!-- PROFIT SIMULATOR (NEW) -->
            <section class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 mt-6 border-t-4 border-t-emerald-500">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                        <i data-lucide="coins" class="text-emerald-600 w-5 h-5"></i>
                        Simulador de Lucro
                    </h3>
                    <button onclick="toggleInfo()" class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 font-medium bg-blue-50 px-3 py-1 rounded-full transition-colors">
                        <i data-lucide="info" class="w-4 h-4"></i> Entenda o Poder das Múltiplas
                    </button>
                </div>
                
                <!-- Info Box (Collapsible) -->
                <div id="info-box" class="accordion-content bg-slate-50 rounded-xl border border-slate-200 mb-6">
                    <div class="p-4 text-xs md:text-sm text-slate-600 space-y-3">
                        <h4 class="font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="lightbulb" class="w-4 h-4 text-amber-500"></i>
                            Por que apostar com mais de 15 números?
                        </h4>
                        <ul class="space-y-2 list-disc pl-4">
                            <li><strong>Educação Financeira:</strong> Uma aposta de 16 números custa R$ 48,00 porque ela equivale matematicamente a fazer 16 jogos de 15 números diferentes.</li>
                            <li><strong>Multiplicação de Prêmios:</strong> Se você joga com 18 números e acerta apenas 14, você não ganha só um prêmio. Você ganha <strong>4 prêmios de 14 pontos</strong> + dezenas de prêmios de 13, 12 e 11, muitas vezes recuperando e lucrando sobre o investimento mesmo sem acertar os 15 pontos.</li>
                            <li><strong>Análise de Risco:</strong> A probabilidade salta drasticamente. Com 15 números é 1 em 3 milhões. Com 18 números, cai para 1 em 4 mil!</li>
                        </ul>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2">
                                Estimativa 15 Pontos (R$):
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-4 h-4 text-purple-400"></i>
                                    <div class="tooltip-content">
                                        Valor variável. Confira no site da Caixa. Média comum: R$ 1.500.000,00 (Finais 0: R$ 4.000.000,00+).
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="prize-15" value="1500000" onchange="simulateProfit()" class="w-full p-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2">
                                Estimativa 14 Pontos (R$):
                                <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                    <i data-lucide="circle-help" class="tooltip-icon w-4 h-4 text-purple-400"></i>
                                    <div class="tooltip-content">
                                        Valor variável. Média histórica de mercado: ~R$ 1.500,00. Varia conforme arrecadação.
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="prize-14" value="1500" onchange="simulateProfit()" class="w-full p-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                    </div>
                    
                    <div>
                         <label class="block text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                             Quantos números eu acertei?
                             <div class="tooltip-wrapper" onclick="toggleTooltip(this, event)">
                                <i data-lucide="circle-help" class="tooltip-icon w-4 h-4 text-purple-400"></i>
                                <div class="tooltip-content">
                                    Simule o resultado. Prêmios de 11, 12 e 13 são fixos (R$ 6, 12, 30). Se você joga com 16+ números, esses prêmios se multiplicam.
                                </div>
                            </div>
                         </label>
                         <select id="hits-select" onchange="simulateProfit()" class="w-full p-3 rounded-xl border border-slate-300 bg-white text-slate-800 font-bold focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="11">Acertei 11 números</option>
                            <option value="12">Acertei 12 números</option>
                            <option value="13">Acertei 13 números</option>
                            <option value="14" selected>Acertei 14 números (Recomendado)</option>
                            <option value="15">Acertei 15 números (Prêmio Máximo)</option>
                        </select>
                    </div>
                </div>

                <div id="profit-simulation-container">
                    <!-- Results injected here -->
                </div>
            </section>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-xs md:text-sm text-blue-800 flex items-start gap-3 mt-6">
                <div class="mt-0.5 bg-blue-100 p-1 rounded-full"><i data-lucide="shield-alert" class="w-3 h-3 md:w-4 md:h-4 text-blue-600"></i></div>
                <p>Segurança Ativa: O algoritmo verifica histórico + salvos para garantir 100% de unicidade.</p>
            </div>
        </section>

        <!-- Saved Section -->
        <section id="saved-section" class="hidden-section max-w-4xl mx-auto animate-fade-in">
            <!-- CHECKER CARD (CONFERIDOR) -->
            <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600"></i> 
                        Conferir Resultado
                    </h3>
                    <div class="text-sm">
                        <span id="check-count" class="font-bold text-purple-600">0</span>/15 selecionados
                    </div>
                </div>
                
                <!-- Grid 1-25 -->
                <div class="grid grid-cols-5 gap-2 md:gap-3 mb-6" id="checker-grid">
                    <!-- Gerado via JS -->
                </div>

                <div class="flex gap-3">
                    <button onclick="clearChecker()" class="flex-1 py-3 rounded-xl border border-slate-200 text-slate-500 font-medium hover:bg-slate-50 transition-colors text-sm">
                        Limpar
                    </button>
                    <button onclick="performCheck()" class="flex-[2] py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition-colors shadow-lg shadow-green-200 active:scale-95 text-sm">
                        Conferir & Excluir
                    </button>
                </div>
                <p class="text-[10px] text-center text-slate-400 mt-2">Ao conferir, este resultado será adicionado à lista de exclusão para não ser gerado novamente.</p>
            </div>

            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">Meus Jogos</h2>
                        <p class="text-xs md:text-sm text-slate-500">Bloqueados no gerador</p>
                    </div>
                    <button onclick="exportToPDF()" class="p-2 bg-white border border-slate-200 shadow-sm rounded-full text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-all active:scale-95 flex items-center justify-center" title="Compartilhar PDF">
                        <i data-lucide="share-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="bg-purple-100 text-purple-800 px-3 py-1 md:px-4 md:py-2 rounded-full font-bold text-xs md:text-sm">
                    Total: <span id="saved-count-display">0</span>
                </div>
            </div>

            <!-- Filtros e Ordenação Mobile-First -->
            <div class="flex flex-col gap-3 mb-6">
                <!-- Filtros Tipo (Scroll Horizontal) -->
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <button onclick="filterSavedGames('all')" id="filter-all" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-medium bg-purple-600 text-white transition-colors border border-transparent whitespace-nowrap">Todos</button>
                    <button onclick="filterSavedGames('smart')" id="filter-smart" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-medium bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors border border-transparent whitespace-nowrap">IA Estatística</button>
                    <button onclick="filterSavedGames('random')" id="filter-random" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-medium bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors border border-transparent whitespace-nowrap">Surpresinha</button>
                </div>
                
                <!-- Filtro Ordenação -->
                <div class="w-full">
                    <div class="relative">
                        <i data-lucide="arrow-up-down" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <select onchange="sortSavedGames(this.value)" class="w-full text-xs md:text-sm border border-slate-200 rounded-lg py-3 pl-9 pr-4 bg-white text-slate-600 focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none">
                            <option value="newest">Ordenar por: Mais Recentes</option>
                            <option value="oldest">Ordenar por: Mais Antigos</option>
                            <option value="sumAsc">Ordenar por: Menor Soma</option>
                            <option value="sumDesc">Ordenar por: Maior Soma</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="saved-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                <!-- Jogos salvos inseridos via JS -->
            </div>
            
            <div id="saved-empty" class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-slate-200 hidden">
                <div class="w-12 h-12 md:w-16 md:h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="list" class="w-6 h-6 md:w-8 md:h-8 text-slate-300"></i>
                </div>
                <h3 class="text-base md:text-lg font-medium text-slate-600">Nenhum jogo salvo</h3>
                <p class="text-xs md:text-sm text-slate-400 mt-1">Gere jogos novos e salve-os.</p>
            </div>

            <div id="saved-actions" class="mt-8 text-center border-t border-slate-200 pt-6 hidden">
                <button onclick="clearSavedGames()" class="text-red-500 text-xs md:text-sm hover:text-red-600 hover:underline transition-colors p-2">
                    Limpar toda a lista
                </button>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="text-center p-4 md:p-6 text-slate-400 text-xs md:text-sm border-t border-slate-200 mt-auto bg-slate-50">
        <p>Desenvolvido por <a href="https://wa.me/5584999780963" target="_blank" class="text-purple-600 hover:underline font-bold flex items-center justify-center gap-1 inline-flex"><i data-lucide="message-circle" class="w-3 h-3"></i> Danilo Arruda</a></p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS ---
        const MOLDURA_NUMBERS = [1, 2, 3, 4, 5, 6, 10, 11, 15, 16, 20, 21, 22, 23, 24, 25];
        
        // Prize Multiplier Matrix (Standard Caixa logic for Lotofacil)
        // Format: [played_count][hits] -> { prize_tier: count_of_prizes }
        const prizeMatrix = {
            15: { 15: {15:1}, 14: {14:1}, 13: {13:1}, 12: {12:1}, 11: {11:1} },
            16: { 15: {15:1, 14:15}, 14: {14:2, 13:14}, 13: {13:3, 12:13}, 12: {12:4, 11:12}, 11: {11:5} },
            17: { 15: {15:1, 14:30, 13:105}, 14: {14:3, 13:42, 12:91}, 13: {13:6, 12:52, 11:78}, 12: {12:10, 11:66}, 11: {11:15} },
            18: { 15: {15:1, 14:45, 13:315, 12:455}, 14: {14:4, 13:84, 12:364, 11:364}, 13: {13:10, 12:130, 11:390}, 12: {12:20, 11:180}, 11: {11:35} },
            19: { 15: {15:1, 14:60, 13:630, 12:1365, 11:1365}, 14: {14:5, 13:140, 12:840, 11:1365}, 13: {13:15, 12:260, 11:1170}, 12: {12:35, 11:420}, 11: {11:70} },
            20: { 15: {15:1, 14:75, 13:1050, 12:3412, 11:3412}, 14: {14:6, 13:210, 12:1680, 11:3465}, 13: {13:21, 12:455, 11:2730}, 12: {12:56, 11:840}, 11: {11:126} }
        };

        // --- STATE MANAGEMENT ---
        const state = {
            data: [],
            stats: null,
            historicalSet: new Set(),
            savedGames: JSON.parse(localStorage.getItem('lotoFacilSavedGames') || '[]'),
            generatedNumbers: [],
            generationType: '',
            filter: 'all', 
            sort: 'newest',
            checkNumbers: new Set(),
            lastCheckResult: null
        };

        // --- WEB WORKER (Inline) ---
        const workerBlob = new Blob([`
            self.onmessage = function(e) {
                try {
                    const text = e.data;
                    const lines = text.split('\\n');
                    const parsedData = [];
                    const historyArray = []; 
                    let malformedCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const cols = line.split(';');
                        if (cols.length < 17) { malformedCount++; continue; }

                        const numbers = [];
                        let hasInvalidNumber = false;
                        for (let j = 2; j <= 16; j++) {
                            const num = parseInt(cols[j]);
                            if (isNaN(num) || num < 1 || num > 25) { hasInvalidNumber = true; break; }
                            numbers.push(num);
                        }

                        if (hasInvalidNumber || numbers.length !== 15) { malformedCount++; continue; }

                        const sortedNums = [...numbers].sort((a, b) => a - b);
                        parsedData.push({ concurso: parseInt(cols[0]), data: cols[1], numbers: sortedNums });
                        historyArray.push(sortedNums.join(','));
                    }

                    if (parsedData.length === 0) throw new Error("Nenhum dado válido encontrado.");

                    self.postMessage({ success: true, parsedData, historyArray, malformedCount });
                } catch (err) {
                    self.postMessage({ success: false, error: err.message });
                }
            };
        `], { type: 'application/javascript' });

        // --- CHARTS INSTANCES ---
        let sumTrendChartInstance = null; // Renamed chart instance

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateSavedBadge();
            renderCheckerGrid(); // Inicializa o grid do conferidor
            
            // Tentar carregar CSV do cache
            const cachedCSV = localStorage.getItem('lotoFacilCSVData');
            if (cachedCSV) {
                try {
                    const parsedData = JSON.parse(cachedCSV);
                    if (parsedData.length > 0) {
                        processData(parsedData, new Set(parsedData.map(d => d.numbers.join(','))), 0, true);
                    }
                } catch(e) { console.error("Cache inválido", e); }
            } else {
                switchView('upload');
            }
            
            // Init Simulators
            calculateMultiple();
            simulateProfit();
        });

        // --- NAVIGATION ---
        function switchView(viewName) {
            // Hide all sections
            document.getElementById('upload-section').classList.add('hidden-section');
            document.getElementById('dashboard-section').classList.add('hidden-section');
            document.getElementById('generator-section').classList.add('hidden-section');
            document.getElementById('saved-section').classList.add('hidden-section');
            document.getElementById('global-loader').classList.add('hidden');

            // Reset Nav Styles
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-white', 'text-purple-900', 'shadow-md', 'font-bold');
                btn.classList.add('text-purple-200', 'hover:bg-purple-700');
            });

            // Show selected
            if (!state.stats && viewName !== 'upload') {
                showNotification('Carregue os dados primeiro!', 'error');
                document.getElementById('upload-section').classList.remove('hidden-section');
                return;
            }

            if (viewName === 'upload') {
                document.getElementById('upload-section').classList.remove('hidden-section');
            } else {
                document.getElementById(`${viewName}-section`).classList.remove('hidden-section');
                const navBtn = document.getElementById(`nav-${viewName}`);
                if(navBtn) {
                    navBtn.classList.remove('text-purple-200', 'hover:bg-purple-700');
                    navBtn.classList.add('bg-white', 'text-purple-900', 'shadow-md', 'font-bold');
                }
                
                if (viewName === 'dashboard') {
                    setTimeout(() => {
                        renderCharts();
                        lucide.createIcons();
                    }, 50); 
                }
                if (viewName === 'saved') renderSavedList();
                if (viewName === 'generator') {
                    updateGeneratorUI();
                    calculateMultiple(); // Refresh calcs
                } 
            }
        }

        // --- FILE UPLOAD & PROCESSING ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('upload-section').classList.add('hidden-section');
            document.getElementById('global-loader').classList.remove('hidden');

            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const csvOutput = XLSX.utils.sheet_to_csv(worksheet, { FS: ";" });
                    processCsvContent(csvOutput);
                };
                reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => { processCsvContent(e.target.result); };
                reader.readAsText(file);
            }
        }

        function processCsvContent(content) {
            const worker = new Worker(URL.createObjectURL(workerBlob));
            worker.onmessage = (event) => {
                const { success, parsedData, historyArray, error, malformedCount } = event.data;
                if (success) {
                    try {
                        localStorage.setItem('lotoFacilCSVData', JSON.stringify(parsedData));
                    } catch(e) { showNotification('Arquivo muito grande para o cache, mas carregado.', 'warning'); }
                    processData(parsedData, new Set(historyArray), malformedCount);
                } else {
                    showNotification(error, 'error');
                    switchView('upload');
                }
                worker.terminate();
            };
            worker.postMessage(content);
        }

        function processData(parsedData, historySet, malformedCount = 0, isCached = false) {
            state.data = parsedData;
            state.historicalSet = historySet;
            analyzeStats(parsedData);
            document.getElementById('global-loader').classList.add('hidden');
            switchView('dashboard');
            const msg = isCached ? 'Dados recuperados do cache!' : `Sucesso! ${malformedCount} linhas ignoradas.`;
            showNotification(msg, 'success');
        }

        function clearDatabase() {
            if(confirm('Apagar base de dados do navegador?')) {
                localStorage.removeItem('lotoFacilCSVData');
                state.data = [];
                state.stats = null;
                state.historicalSet = new Set();
                location.reload();
            }
        }

        // --- CHECKER LOGIC ---
        function renderCheckerGrid() {
            const grid = document.getElementById('checker-grid');
            grid.innerHTML = '';
            for(let i=1; i<=25; i++) {
                const btn = document.createElement('button');
                btn.className = `w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full border transition-all text-sm font-bold bg-white text-slate-500 border-slate-200 hover:border-purple-300`;
                btn.innerText = i;
                btn.onclick = () => toggleCheckNumber(i, btn);
                btn.id = `check-btn-${i}`;
                grid.appendChild(btn);
            }
        }

        function toggleCheckNumber(n, btn) {
            if (state.checkNumbers.has(n)) {
                state.checkNumbers.delete(n);
                btn.className = `w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full border transition-all text-sm font-bold bg-white text-slate-500 border-slate-200 hover:border-purple-300`;
            } else {
                if (state.checkNumbers.size >= 15) return showNotification('Máximo 15 números!', 'warning');
                state.checkNumbers.add(n);
                btn.className = `w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full border transition-all text-sm font-bold bg-purple-600 text-white border-purple-600 shadow-md transform scale-105`;
            }
            document.getElementById('check-count').innerText = state.checkNumbers.size;
        }

        function clearChecker() {
            state.checkNumbers.clear();
            state.lastCheckResult = null;
            document.getElementById('check-count').innerText = 0;
            renderCheckerGrid();
            renderSavedList(); 
        }

        function performCheck() {
            if (state.checkNumbers.size !== 15) return showNotification('Selecione exatamente 15 números!', 'warning');
            
            const resultArr = Array.from(state.checkNumbers).sort((a,b)=>a-b);
            state.lastCheckResult = new Set(resultArr);

            const resultKey = resultArr.join(',');
            if (!state.historicalSet.has(resultKey)) {
                state.historicalSet.add(resultKey);
                updateGeneratorUI(); 
                showNotification('Conferido! Jogo adicionado à lista de exclusão.', 'success');
            } else {
                showNotification('Conferido! (Jogo já estava na exclusão)', 'success');
            }

            renderSavedList();
        }

        // --- INVESTMENT SIMULATOR LOGIC ---
        function calculateMultiple() {
            const data = {
                15: { price: 3, prob: "3.268.760", eq: 1 },
                16: { price: 48, prob: "204.297", eq: 16 },
                17: { price: 408, prob: "24.035", eq: 136 },
                18: { price: 2448, prob: "4.005", eq: 816 },
                19: { price: 11628, prob: "843", eq: 3876 },
                20: { price: 46512, prob: "211", eq: 15504 }
            };

            const selected = document.getElementById('multiple-select').value;
            const basePrice = parseFloat(document.getElementById('base-price').value) || 3.00;
            const result = data[selected];

            // Calculate based on user input base price (Standard: base * equivalence)
            const totalPrice = basePrice * result.eq;

            document.getElementById('calc-price').innerText = `R$ ${totalPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('calc-prob').innerText = `1 em ${result.prob}`;
            document.getElementById('calc-eq').innerText = `Equivale a ${result.eq.toLocaleString('pt-BR')} apostas simples`;
            
            // Recalculate profit if available
            simulateProfit();
        }

        // --- PROFIT SIMULATOR LOGIC (NEW) ---
        function simulateProfit() {
            const nJogados = parseInt(document.getElementById('multiple-select').value);
            const acertos = parseInt(document.getElementById('hits-select').value);
            
            // Get Prize Values
            const v15 = parseFloat(document.getElementById('prize-15').value) || 1500000;
            const v14 = parseFloat(document.getElementById('prize-14').value) || 1500;
            const v13 = 30.0;
            const v12 = 12.0;
            const v11 = 6.0;

            // Get Cost
            // We use the same calculation as Investment Simulator: Base Price * Equivalence
            const dataEq = { 15: 1, 16: 16, 17: 136, 18: 816, 19: 3876, 20: 15504 };
            const basePrice = parseFloat(document.getElementById('base-price').value) || 3.00;
            const custoAposta = basePrice * dataEq[nJogados];

            // Calculate Winnings Breakdown based on Matrix
            const breakdown = (prizeMatrix[nJogados] && prizeMatrix[nJogados][acertos]) ? prizeMatrix[nJogados][acertos] : {};
            
            // Calculate Gross Total
            const totalBruto = (breakdown[15] || 0) * v15 +
                               (breakdown[14] || 0) * v14 +
                               (breakdown[13] || 0) * v13 +
                               (breakdown[12] || 0) * v12 +
                               (breakdown[11] || 0) * v11;
                               
            const liquido = totalBruto - custoAposta;

            // Generate HTML for result
            const html = `
                <div class="mt-4 p-4 ${liquido > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200'} rounded-xl border shadow-sm">
                    <h4 class="font-bold text-sm mb-3 text-slate-800 border-b pb-2 ${liquido > 0 ? 'border-emerald-200' : 'border-red-200'}">
                        Resultado Simulado: Jogar ${nJogados} e Acertar ${acertos}
                    </h4>
                    
                    <div class="space-y-1 mb-3">
                         ${breakdown[15] ? `<div class="flex justify-between text-xs"><span class="text-slate-600">15 Pontos (${breakdown[15]}x):</span> <span class="font-medium">R$ ${(breakdown[15]*v15).toLocaleString('pt-BR')}</span></div>` : ''}
                         ${breakdown[14] ? `<div class="flex justify-between text-xs"><span class="text-slate-600">14 Pontos (${breakdown[14]}x):</span> <span class="font-medium">R$ ${(breakdown[14]*v14).toLocaleString('pt-BR')}</span></div>` : ''}
                         ${breakdown[13] ? `<div class="flex justify-between text-xs"><span class="text-slate-600">13 Pontos (${breakdown[13]}x):</span> <span class="font-medium">R$ ${(breakdown[13]*v13).toLocaleString('pt-BR')}</span></div>` : ''}
                         ${breakdown[12] ? `<div class="flex justify-between text-xs"><span class="text-slate-600">12 Pontos (${breakdown[12]}x):</span> <span class="font-medium">R$ ${(breakdown[12]*v12).toLocaleString('pt-BR')}</span></div>` : ''}
                         ${breakdown[11] ? `<div class="flex justify-between text-xs"><span class="text-slate-600">11 Pontos (${breakdown[11]}x):</span> <span class="font-medium">R$ ${(breakdown[11]*v11).toLocaleString('pt-BR')}</span></div>` : ''}
                         ${Object.keys(breakdown).length === 0 ? '<div class="text-xs text-red-500 italic">Nenhum prêmio para essa combinação.</div>' : ''}
                    </div>

                    <div class="flex justify-between text-xs mb-1 pt-2 border-t border-dashed ${liquido > 0 ? 'border-emerald-200' : 'border-red-200'}">
                        <span>Total Prêmios:</span>
                        <span class="font-bold text-emerald-600">R$ ${totalBruto.toLocaleString('pt-BR')}</span>
                    </div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>Custo Aposta:</span>
                        <span class="text-red-500">- R$ ${custoAposta.toLocaleString('pt-BR')}</span>
                    </div>
                    <div class="pt-2 border-t border-slate-200 flex justify-between items-center bg-white p-2 rounded-lg">
                        <span class="text-xs font-bold text-slate-700">LUCRO LÍQUIDO:</span>
                        <span class="text-base font-black ${liquido > 0 ? 'text-blue-600' : 'text-red-600'}">
                            R$ ${liquido.toLocaleString('pt-BR')}
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('profit-simulation-container').innerHTML = html;
        }

        function toggleInfo() {
            const infoBox = document.getElementById('info-box');
            if (infoBox.style.maxHeight) {
                infoBox.style.maxHeight = null;
                infoBox.style.opacity = 0;
            } else {
                infoBox.style.maxHeight = infoBox.scrollHeight + "px";
                infoBox.style.opacity = 1;
            }
        }

        function toggleTooltip(el, e) {
            // Only relevant for mobile/touch or click interaction
            e.stopPropagation();
            
            // Close others
            document.querySelectorAll('.tooltip-wrapper').forEach(t => {
                if(t !== el) t.classList.remove('tooltip-open');
            });
            
            el.classList.toggle('tooltip-open');
        }

        // Close on outside click
        document.addEventListener('click', () => {
            document.querySelectorAll('.tooltip-wrapper').forEach(t => t.classList.remove('tooltip-open'));
        });

        // --- STATISTICS & ANALYSIS ---
        function analyzeStats(draws) {
            const frequency = Array(26).fill(0);
            let sums = [];
            // Changed from simple counts to full distribution array for bar chart
            const oddDistribution = Array(16).fill(0); // 0 to 15 odds
            
            // New logic for lags (atraso)
            const lags = {};

            draws.forEach(d => {
                let currentOdd = 0;
                let currentSum = 0;
                d.numbers.forEach(n => {
                    frequency[n]++;
                    if(n % 2 !== 0) currentOdd++;
                    currentSum += n;
                });
                sums.push(currentSum);
                // Track specific odd counts per game
                oddDistribution[currentOdd]++;
            });

            // Calculate lag for each number (1-25)
            // Assuming draws[0] is the latest
            for (let n = 1; n <= 25; n++) {
                let lag = 0;
                for (let i = 0; i < draws.length; i++) {
                    if (draws[i].numbers.includes(n)) {
                        break;
                    }
                    lag++;
                }
                lags[n] = lag;
            }

            const total = draws.length;
            const freqData = frequency.slice(1).map((c, i) => ({ n: i+1, c, pct: ((c/total)*100).toFixed(1) })).sort((a,b) => b.c - a.c);
            
            sums.sort((a,b) => a-b);
            const avg = sums.reduce((a,b) => a+b, 0) / total;
            const mid = Math.floor(sums.length/2);
            const median = sums.length % 2 !== 0 ? sums[mid] : (sums[mid-1] + sums[mid])/2;
            const variance = sums.reduce((acc, val) => acc + Math.pow(val - avg, 2), 0) / total;
            
            const sumMap = {}; let maxFreq=0;
            sums.forEach(s => { sumMap[s] = (sumMap[s]||0)+1; if(sumMap[s]>maxFreq) maxFreq=sumMap[s]; });
            const mode = Object.keys(sumMap).find(key => sumMap[key] === maxFreq);

            state.stats = {
                totalDraws: total,
                frequency: freqData,
                hot: freqData.slice(0, 5),
                cold: freqData.slice(-5),
                oddDistribution: oddDistribution, // New detailed stat
                sumStats: { avg: Math.round(avg), median, mode, stdDev: Math.sqrt(variance).toFixed(2) },
                lags: lags // New property for lags
            };

            updateDashboardDOM();
        }

        function updateDashboardDOM() {
            const s = state.stats;
            document.getElementById('stat-avg').innerText = s.sumStats.avg;
            document.getElementById('stat-median').innerText = s.sumStats.median;
            document.getElementById('stat-mode').innerText = s.sumStats.mode;
            document.getElementById('stat-stdDev').innerText = s.sumStats.stdDev;
            
            // ATUALIZAÇÃO DO KPI TOTAL
            if (document.getElementById('kpi-total')) {
                // Se já temos dados da API que atualizaram o texto, mantemos.
                // Caso contrário, usamos o total do CSV.
                // Mas, se a função obterLotofacil rodou, ela atualizou o texto.
                // Aqui, vamos garantir que mostre o total do CSV a menos que explicitamente alterado pela API.
                // Porém, a melhor lógica é: mostrar o maior valor conhecido.
                const currentText = document.getElementById('kpi-total').innerText;
                const currentVal = parseInt(currentText) || 0;
                
                if (s.totalDraws > currentVal) {
                     document.getElementById('kpi-total').innerText = s.totalDraws;
                }
            }
            
            document.getElementById('kpi-excluded').innerText = s.totalDraws + state.savedGames.length;
            document.getElementById('kpi-excluded-sub').innerText = `+${state.savedGames.length} salvos`;
            
            document.getElementById('kpi-hot-num').innerText = s.hot[0].n;
            document.getElementById('kpi-hot-pct').innerText = s.hot[0].pct + '%';
            
            document.getElementById('kpi-cold-num').innerText = s.cold[s.cold.length-1].n;
            document.getElementById('kpi-cold-pct').innerText = s.cold[s.cold.length-1].pct + '%';
        }

        function renderCharts() {
            if(!state.stats) return;
            renderHeatmap(); 

            // --- Updated Chart Logic: Sum Trend (Last 20 Games) ---
            const ctxSumTrend = document.getElementById('sumTrendChart').getContext('2d');
            
            if(sumTrendChartInstance) sumTrendChartInstance.destroy();
            
            // Get last 20 games chronologically (Assuming state.data is sorted descending)
            const last20Games = state.data.slice(0, 20).reverse();
            
            const labels = last20Games.map(game => game.concurso);
            const dataPoints = last20Games.map(game => game.numbers.reduce((a,b) => a+b, 0));
            const averageSum = 195; // Theoretical average for 15 numbers (1-25)

            sumTrendChartInstance = new Chart(ctxSumTrend, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Soma das Dezenas',
                            data: dataPoints,
                            borderColor: '#8b5cf6', // Purple-500
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#8b5cf6',
                            pointRadius: 4,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Média (195)',
                            data: Array(last20Games.length).fill(averageSum),
                            borderColor: '#94a3b8', // Slate-400
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { font: { size: 10 }, boxWidth: 10 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 8,
                            titleFont: { size: 11 },
                            bodyFont: { size: 11 }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 10 } },
                            suggestedMin: 150,
                            suggestedMax: 240
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 9 }, maxRotation: 45 }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function renderHeatmap() {
            const container = document.getElementById('freq-heatmap');
            container.innerHTML = '';
            
            const sortedByNum = [...state.stats.frequency].sort((a,b) => a.n - b.n);
            const counts = sortedByNum.map(d => d.c);
            const max = Math.max(...counts);
            const min = Math.min(...counts);
            const range = max - min;

            for(let i=1; i<=25; i++) {
                const stat = sortedByNum.find(d => d.n === i) || {c:0, pct:0};
                const normalized = (stat.c - min) / range; 
                let bgColor, textColor;
                
                if (normalized < 0.3) {
                    const alpha = 0.2 + (0.3 - normalized); 
                    bgColor = `rgba(59, 130, 246, ${alpha})`; 
                    textColor = 'text-blue-800';
                } else if (normalized > 0.7) {
                    const alpha = 0.3 + (normalized - 0.7);
                    bgColor = `rgba(34, 197, 94, ${alpha})`; 
                    textColor = 'text-green-900 font-bold';
                } else {
                    bgColor = '#f1f5f9'; 
                    textColor = 'text-slate-600';
                }

                const isHot = state.stats.hot.some(h => h.n === i);
                const isCold = state.stats.cold.some(c => c.n === i);
                if(isHot) { bgColor = '#dcfce7'; textColor = 'text-green-700 font-bold border-green-400'; } 
                if(isCold) { bgColor = '#dbeafe'; textColor = 'text-blue-700 border-blue-400'; } 

                const div = document.createElement('div');
                div.className = `heatmap-cell w-full h-full flex flex-col items-center justify-center rounded-lg border text-sm ${textColor} cursor-pointer hover:shadow-lg`;
                div.style.backgroundColor = bgColor;
                if(!isHot && !isCold) div.style.borderColor = 'transparent';
                
                div.onclick = () => showNumberDetails(i); // Add click handler

                div.innerHTML = `
                    <span class="text-base">${i}</span>
                    <span class="text-[9px] opacity-80">${stat.pct}%</span>
                `;
                
                container.appendChild(div);
            }
        }

        function showNumberDetails(num) {
            const stats = state.stats;
            const freq = stats.frequency.find(f => f.n === num);
            const lag = stats.lags[num];
            
            // Format lag text nicely
            let lagText = "";
            if (lag === 0) {
                lagText = "Saiu no último concurso! 🔥";
            } else if (lag === 1) {
                lagText = "Não sai há 1 concurso.";
            } else {
                lagText = `Não sai há ${lag} concursos.`;
            }

            // Using the existing notification system for a consistent UI
            showNotification(`🎱 Dezena ${num}: ${lagText}`, 'info');
        }

        // --- GENERATOR LOGIC (SecureRandom with Weighted Pool) ---
        function getSecureRandomInt(min, max) {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            const randomFloat = array[0] / (0xFFFFFFFF + 1);
            return Math.floor(randomFloat * (max - min + 1)) + min;
        }

        function generateGame(type) {
            if(!state.stats) return;
            const s = state.stats;
            
            // Constants needed for filters
            // MOLDURA_NUMBERS is defined at the top
            
            let attempts = 0, maxAttempts = 20000; // Increased due to stricter filters
            let found = false;
            
            // Weighted Logic for 'Smart' Generation
            let weightedPool = [];
            if(type === 'smart') {
                const counts = s.frequency.map(f => f.c).sort((a,b) => a-b);
                const lowerThreshold = counts[4]; // 5th lowest
                const upperThreshold = counts[counts.length - 5]; // 5th highest
                
                // Build pool: 1-25 with weights
                const numbers = Array.from({length: 25}, (_, i) => i + 1);
                weightedPool = numbers.flatMap(num => {
                    const stat = s.frequency.find(f => f.n === num);
                    const freq = stat ? stat.c : 0;
                    
                    if (freq >= upperThreshold) return Array(1).fill(num); // Hot (Weight 1)
                    if (freq <= lowerThreshold) return Array(2).fill(num); // Cold (Weight 2)
                    return Array(4).fill(num); // Medium (Weight 4)
                });
            }

            // Check if user wants to use last draw repeat logic
            const useRepeatFilter = document.getElementById('repeat-toggle') && document.getElementById('repeat-toggle').checked;
            const lastGameNumbers = (useRepeatFilter && state.data.length > 0) ? state.data[0].numbers : null;

            while(!found && attempts < maxAttempts) {
                attempts++;
                let tempSet = new Set();
                
                if(type === 'random') {
                    while(tempSet.size < 15) tempSet.add(getSecureRandomInt(1, 25));
                } else {
                    // Smart weighted draw
                    while(tempSet.size < 15) {
                        const randomIndex = getSecureRandomInt(0, weightedPool.length - 1);
                        tempSet.add(weightedPool[randomIndex]);
                    }
                }

                const arr = Array.from(tempSet).sort((a,b) => a-b);
                
                // --- SMART FILTERS ---
                if(type === 'smart') {
                    // 1. Odd/Even Check
                    const odds = arr.filter(n => n%2!==0).length;
                    
                    // 2. Sum Check
                    const sum = arr.reduce((a,b) => a+b, 0);
                    const minSum = s.sumStats.avg - (parseFloat(s.sumStats.stdDev) * 1.5);
                    const maxSum = s.sumStats.avg + (parseFloat(s.sumStats.stdDev) * 1.5);
                    
                    // 3. NEW: Frame (Moldura) Check - Expect 8 to 11
                    const frameCount = arr.filter(n => MOLDURA_NUMBERS.includes(n)).length;
                    if (frameCount < 8 || frameCount > 11) continue;

                    // 4. NEW: Sequence Cluster Check - Reject sequences > 5
                    let maxSequence = 1;
                    let currentSequence = 1;
                    for (let i = 1; i < arr.length; i++) {
                        if (arr[i] === arr[i-1] + 1) {
                            currentSequence++;
                        } else {
                            if (currentSequence > maxSequence) maxSequence = currentSequence;
                            currentSequence = 1;
                        }
                    }
                    if (currentSequence > maxSequence) maxSequence = currentSequence;
                    if (maxSequence > 5) continue; // Reject impossible sequences like 1,2,3,4,5,6

                    // 5. NEW: Repeats from Previous Game - Expect 8 to 10
                    if (useRepeatFilter && lastGameNumbers) {
                        const repeats = arr.filter(n => lastGameNumbers.includes(n)).length;
                        if (repeats < 8 || repeats > 10) continue;
                    }
                    
                    // Combine basic stats checks
                    if(!(odds >= 7 && odds <= 9 && sum >= minSum && sum <= maxSum)) continue;
                }

                // Uniqueness Check
                const key = arr.join(',');
                if(!state.historicalSet.has(key) && !state.savedGames.some(g => g.numbers.join(',') === key)) {
                    state.generatedNumbers = arr;
                    state.generationType = type === 'smart' ? 'IA Estatística' : 'Surpresinha';
                    found = true;
                }
            }

            if(found) {
                updateGeneratorUI(true);
            } else {
                showNotification('Não foi possível gerar um jogo com esses filtros. Tente novamente.', 'error');
            }
        }

        function updateGeneratorUI(hasGame = false) {
            const display = document.getElementById('generator-display');
            const saveArea = document.getElementById('save-area');
            const exclusion = document.getElementById('gen-exclusion-count');
            
            // UPDATED LOGIC: Count from Historical Set (API + CSV) + Saved Games
            exclusion.innerText = state.historicalSet.size + state.savedGames.length;

            if(!hasGame && state.generatedNumbers.length === 0) {
                display.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-slate-300 h-32 border-2 border-dashed border-slate-100 rounded-xl w-full bg-slate-50/50">
                        <i data-lucide="play-circle" class="w-12 h-12 mb-3 opacity-20"></i>
                        <span class="italic font-medium text-sm md:text-base">Gere um novo jogo</span>
                    </div>`;
                saveArea.classList.add('hidden');
                lucide.createIcons();
                return;
            }

            display.innerHTML = state.generatedNumbers.map(n => {
                const isHot = state.stats.hot.some(h => h.n === n);
                const isCold = state.stats.cold.some(c => c.n === n);
                let classes = "bg-white text-slate-700 border-slate-200";
                if(isHot) classes = "bg-red-100 text-red-700 border-red-300 font-bold";
                if(isCold) classes = "bg-blue-100 text-blue-700 border-blue-300";
                return `<div class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center text-lg md:text-xl font-bold rounded-full shadow-md border-2 ${classes}">${n}</div>`;
            }).join('');

            const sum = state.generatedNumbers.reduce((a,b)=>a+b,0);
            const odd = state.generatedNumbers.filter(n=>n%2!==0).length;
            
            document.getElementById('gen-sum').innerText = sum;
            document.getElementById('gen-odd').innerText = odd;
            document.getElementById('gen-even').innerText = 15 - odd;
            saveArea.classList.remove('hidden');
        }

        function saveCurrentGame() {
            if(state.generatedNumbers.length !== 15) return;
            const gameKey = state.generatedNumbers.join(',');
            if (state.savedGames.some(g => g.numbers.join(',') === gameKey)) return showNotification('Jogo já salvo!', 'warning');
            
            const newGame = {
                id: Date.now(),
                date: new Date().toLocaleDateString('pt-BR'),
                numbers: state.generatedNumbers,
                type: state.generationType
            };
            
            state.savedGames.unshift(newGame);
            localStorage.setItem('lotoFacilSavedGames', JSON.stringify(state.savedGames));
            updateSavedBadge();
            showNotification('Jogo salvo com sucesso!', 'success');
            
            // Force redraw of exclusion counts
            updateDashboardDOM();
            // Also update the local exclusion count on the generator screen immediately
            document.getElementById('gen-exclusion-count').innerText = state.historicalSet.size + state.savedGames.length;
        }

        // --- SAVED GAMES, FILTER & SORT ---
        function filterSavedGames(type) {
            state.filter = type;
            ['all', 'smart', 'random'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if(t === type) {
                    btn.classList.remove('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
                    btn.classList.add('bg-purple-600', 'text-white');
                } else {
                    btn.classList.add('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
                    btn.classList.remove('bg-purple-600', 'text-white');
                }
            });
            renderSavedList();
        }

        function sortSavedGames(criteria) {
            state.sort = criteria;
            renderSavedList();
        }

        function copyGameNumbers(numbersStr) {
            const numbers = numbersStr.split(',').map(n => n.padStart(2, '0')); // Ensure 2 digits
            const textToCopy = numbers.join(' ');
            
            // iFrame safe copy
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);

            showNotification('Números copiados!', 'success');
        }

        function renderSavedList() {
            const container = document.getElementById('saved-list');
            const empty = document.getElementById('saved-empty');
            const actions = document.getElementById('saved-actions');
            
            document.getElementById('saved-count-display').innerText = state.savedGames.length;

            let gamesToShow = [...state.savedGames];

            // Filter
            if (state.filter === 'smart') gamesToShow = gamesToShow.filter(g => g.type === 'IA Estatística');
            if (state.filter === 'random') gamesToShow = gamesToShow.filter(g => g.type === 'Surpresinha');

            // Sort
            gamesToShow.sort((a, b) => {
                if (state.sort === 'newest') return b.id - a.id;
                if (state.sort === 'oldest') return a.id - b.id;
                const sumA = a.numbers.reduce((acc, n) => acc + n, 0);
                const sumB = b.numbers.reduce((acc, n) => acc + n, 0);
                if (state.sort === 'sumAsc') return sumA - sumB;
                if (state.sort === 'sumDesc') return sumB - sumA;
                return 0;
            });

            if(gamesToShow.length === 0) {
                container.innerHTML = '';
                if (state.savedGames.length === 0) {
                    empty.classList.remove('hidden');
                    actions.classList.add('hidden');
                } else {
                    container.innerHTML = `<div class="col-span-1 md:col-span-2 text-center py-10 text-slate-400 italic text-sm">Nenhum jogo encontrado com este filtro.</div>`;
                    empty.classList.add('hidden');
                    actions.classList.remove('hidden');
                }
                return;
            }

            empty.classList.add('hidden');
            actions.classList.remove('hidden');

            container.innerHTML = gamesToShow.map(game => {
                const sum = game.numbers.reduce((a,b)=>a+b,0);
                const isSurprise = game.type === 'Surpresinha';
                const bgClass = isSurprise ? 'bg-blue-50/50 border-blue-200' : 'bg-white border-slate-200';
                const badgeClass = isSurprise ? 'bg-blue-200 text-blue-800' : 'bg-purple-100 text-purple-700';

                // Check hits if a result is present
                let hits = 0;
                if (state.lastCheckResult) {
                    hits = game.numbers.filter(n => state.lastCheckResult.has(n)).length;
                }

                let badgeColor = 'bg-slate-200 text-slate-700';
                if (hits >= 11 && hits <= 13) badgeColor = 'bg-green-100 text-green-700 font-bold border border-green-200';
                if (hits >= 14) badgeColor = 'bg-yellow-100 text-yellow-700 font-bold border border-yellow-300 animate-pulse';

                return `
                <div class="p-4 md:p-5 rounded-xl shadow-sm border hover:shadow-md transition-shadow relative group ${bgClass}">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[10px] md:text-xs font-bold uppercase tracking-wider px-2 py-1 rounded ${badgeClass}">${game.type}</span>
                        ${state.lastCheckResult ? `<span class="px-2 py-1 rounded text-xs ${badgeColor}">${hits} acertos</span>` : `<span class="text-[10px] md:text-xs text-slate-400">${game.date}</span>`}
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center mb-4">
                        ${game.numbers.map(n => {
                            const isHot = state.stats.hot.some(h => h.n === n);
                            const isCold = state.stats.cold.some(c => c.n === n);
                            const isHit = state.lastCheckResult && state.lastCheckResult.has(n);
                            
                            // Hit highlight overrides others with intense green and scaling
                            if (isHit) {
                                return `<span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center text-xs md:text-sm font-extrabold rounded-full bg-green-600 border-green-700 text-white shadow-md ring-2 ring-green-300 transform scale-110 z-10">${n}</span>`;
                            }

                            let c = "border-slate-200 text-slate-700";
                            if(isHot) c = "border-red-300 bg-red-50 text-red-700";
                            if(isCold) c = "border-blue-300 bg-blue-50 text-blue-700";
                            
                            return `<span class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center text-xs md:text-sm font-bold rounded-full border bg-white ${c}">${n}</span>`
                        }).join('')}
                    </div>
                    <div class="flex flex-col gap-2 border-t border-slate-100 pt-3 md:pt-4 mt-2">
                        <div class="text-xs text-slate-500 font-semibold mb-1">Soma: ${sum}</div>
                        <div class="flex gap-2 w-full">
                            <button onclick="copyGameNumbers('${game.numbers.join(',')}')" class="flex-1 text-xs md:text-sm font-medium py-2 rounded bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors flex items-center justify-center gap-1">
                                <i data-lucide="copy" class="w-3 h-3"></i> Copiar
                            </button>
                            <button onclick="deleteGame(${game.id})" class="w-auto px-3 text-xs md:text-sm font-medium py-2 rounded text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors flex items-center justify-center">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
        }

        function deleteGame(id) {
            state.savedGames = state.savedGames.filter(g => g.id !== id);
            localStorage.setItem('lotoFacilSavedGames', JSON.stringify(state.savedGames));
            updateSavedBadge();
            renderSavedList();
            showNotification('Jogo removido.', 'success');
        }

        function clearSavedGames() {
            if(confirm('Apagar todos os jogos salvos?')) {
                state.savedGames = [];
                localStorage.setItem('lotoFacilSavedGames', JSON.stringify([]));
                updateSavedBadge();
                renderSavedList();
                showNotification('Lista limpa.', 'success');
            }
        }

        function updateSavedBadge() {
            const badge = document.getElementById('saved-badge');
            if(state.savedGames.length > 0) {
                badge.innerText = state.savedGames.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function openProbModal() {
            document.getElementById('prob-modal').classList.remove('hidden');
        }

        function closeProbModal() {
            document.getElementById('prob-modal').classList.add('hidden');
        }
        
        function closeLastGameModal() {
            document.getElementById('last-game-modal').classList.add('hidden');
        }

        // --- EXPORT TO PDF FUNCTION ---
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Filtrar jogos conforme o filtro visual atual
            let gamesToExport = [...state.savedGames];
            if (state.filter === 'smart') gamesToExport = gamesToExport.filter(g => g.type === 'IA Estatística');
            if (state.filter === 'random') gamesToExport = gamesToExport.filter(g => g.type === 'Surpresinha');
            
            // Ordenar conforme a ordenação visual atual
             gamesToExport.sort((a, b) => {
                if (state.sort === 'newest') return b.id - a.id;
                if (state.sort === 'oldest') return a.id - b.id;
                const sumA = a.numbers.reduce((acc, n) => acc + n, 0);
                const sumB = b.numbers.reduce((acc, n) => acc + n, 0);
                if (state.sort === 'sumAsc') return sumA - sumB;
                if (state.sort === 'sumDesc') return sumB - sumA;
                return 0;
            });

            if (gamesToExport.length === 0) {
                showNotification('Nenhum jogo para exportar.', 'warning');
                return;
            }

            // Header
            doc.setFillColor(88, 28, 135); // Purple-900
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text("Bolão Lotofácil - Jogos Selecionados", 105, 13, { align: "center" });

            // Info
            doc.setTextColor(100);
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 28);
            doc.text(`Total de Jogos: ${gamesToExport.length}`, 14, 33);

            // Table Data
            const tableData = gamesToExport.map((game, index) => [
                index + 1,
                game.type,
                game.numbers.map(n => n.toString().padStart(2, '0')).join('  '), // Espaçamento extra para leitura
                game.numbers.reduce((a,b)=>a+b, 0) // Soma
            ]);

            doc.autoTable({
                startY: 40,
                head: [['#', 'Tipo', 'Dezenas', 'Soma']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [147, 51, 234], textColor: 255, fontStyle: 'bold' }, // Purple-600
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center' },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 'auto', font: 'courier' }, // Monospace for numbers
                    3: { cellWidth: 20, halign: 'center' }
                },
                styles: { fontSize: 10, cellPadding: 3 },
                alternateRowStyles: { fillColor: [243, 244, 246] } // Slate-100
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Gerado por LotoFácil Analyst AI', 105, 290, { align: 'center' });
            }

            // Generate blob
            const pdfBlob = doc.output('blob');
            const file = new File([pdfBlob], "bolao_lotofacil.pdf", { type: "application/pdf" });

            // Try native share
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Bolão Lotofácil',
                        text: 'Confira os jogos gerados!'
                    });
                    showNotification('Compartilhado com sucesso!', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                         doc.save('bolao_lotofacil.pdf'); // Fallback
                    }
                }
            } else {
                doc.save('bolao_lotofacil.pdf');
                showNotification('PDF baixado! Envie manualmente.', 'success');
            }
        }

        // --- NEW FUNCTION: Fetch Latest Game from API ---
        async function obterLotofacil() {
            showNotification('Buscando último resultado...', 'info');
            try {
                const response = await fetch("https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest");

                if (!response.ok) {
                    throw new Error("Falha ao buscar dados");
                }

                const data = await response.json();
                const concurso = parseInt(data.concurso);
                const dataSorteio = data.data; // Format DD/MM/YYYY usually
                const dezenas = data.dezenas.map(n => parseInt(n));

                // 1. Atualizar conferidor (Visual)
                state.checkNumbers = new Set(dezenas);
                renderCheckerGrid();
                document.getElementById('check-count').innerText = state.checkNumbers.size;

                // 2. Conferir e Excluir
                performCheck();

                // 3. Modal Info
                document.getElementById('lg-concurso').innerText = concurso;
                document.getElementById('lg-data').innerText = dataSorteio;
                const ballsContainer = document.getElementById('lg-dezenas');
                ballsContainer.innerHTML = dezenas.map(num => {
                    return `<div class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center rounded-full font-bold border-2 border-purple-200 bg-purple-50 text-purple-700 shadow-sm text-sm md:text-base">${num}</div>`;
                }).join('');
                document.getElementById('last-game-modal').classList.remove('hidden');

                // 4. PERSISTÊNCIA E ATUALIZAÇÃO DO BANCO DE DADOS
                // Verificar se já temos dados carregados
                if (!state.data) state.data = [];
                
                // Verificar duplicidade pelo número do concurso
                const exists = state.data.some(d => d.concurso === concurso);

                if (!exists) {
                    const newGame = {
                        concurso: concurso,
                        data: dataSorteio,
                        numbers: dezenas.sort((a,b) => a-b)
                    };

                    // Adicionar ao topo (assumindo ordem decrescente de data/concurso é melhor para visualização, mas a análise lida com tudo)
                    state.data.unshift(newGame);
                    
                    // Atualizar Set Histórico
                    state.historicalSet.add(dezenas.join(','));

                    // Salvar no LocalStorage
                    try {
                        localStorage.setItem('lotoFacilCSVData', JSON.stringify(state.data));
                        showNotification(`Concurso ${concurso} salvo no banco de dados!`, 'success');
                    } catch (e) {
                        console.error("Erro ao salvar no cache", e);
                        showNotification('Erro ao salvar persistentemente (limite de armazenamento).', 'warning');
                    }

                    // Re-analisar tudo para atualizar Dashboard, Gráficos e KPIs
                    analyzeStats(state.data);
                    
                    // Atualizar gráficos se estiverem visíveis
                    if (!document.getElementById('dashboard-section').classList.contains('hidden-section')) {
                        renderCharts();
                    }
                } else {
                    showNotification(`Concurso ${concurso} já existe na base de dados.`, 'info');
                }

            } catch (err) {
                console.error("❌ Erro:", err.message);
                showNotification("Erro ao buscar último jogo. Tente novamente mais tarde.", 'error');
            }
        }

        // --- UTILS ---
        function showNotification(msg, type = 'info') {
            const container = document.getElementById('notification-container');
            const div = document.createElement('div');
            let color = 'bg-slate-800 border-l-4 border-blue-400';
            if(type === 'success') color = 'bg-slate-800 border-l-4 border-green-400';
            if(type === 'error') color = 'bg-red-100 text-red-900 border border-red-200';
            if(type === 'warning') color = 'bg-orange-100 text-orange-900 border border-orange-200';

            div.className = `${color} text-white px-4 py-3 rounded-lg shadow-xl text-xs md:text-sm font-medium animate-bounce pointer-events-auto`;
            if(type === 'error' || type === 'warning') div.classList.remove('text-white');
            div.innerText = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }
    </script>
</body>
</html>